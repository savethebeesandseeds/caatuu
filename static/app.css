:root{
  /* Grid & splits */
  --gap: 3px;
  --col-left: 25%;
  --row-top: 75vh;
  --right-split: 52%;
  --radius: 2px;

  /* Far-right column (default narrower) */
  --col-help: 26%;

  /* Flat dark theme */
  --bg-900:#000000;
  --bg-850:#0d0d0d;
  --bg-820:#151515;
  --edge:#2a2a2a;
  --edge-strong:#3a3a3a;

  /* Text */
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  --text:#e7e7e7;
  --text-dim:#9a9a9a;

  /* Accents */
  --accent-challenge:#22c55e; /* calm emerald */
  --accent-agent:#3ea8ff;     /* azure tone */

  /* Tones */
  --tone1:#ef4444; --tone2:#facc15; --tone3:#22c55e; --tone4:#3ea8ff; --tone5:#a4b0be;
}

*,*::before,*::after{ box-sizing:border-box; }
html{ height:100%; -webkit-text-size-adjust:100%; }
body{
  height:100%;
  margin:0;
  font-family: var(--mono);
  color:var(--text);
  background: var(--bg-900);
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  scrollbar-width: thin;
  scrollbar-color: #474747 #111;
  /* mobile safe area */
  padding-bottom: env(safe-area-inset-bottom, 0px);
  overscroll-behavior-y: contain;
}
body::-webkit-scrollbar{ width:12px; height:12px; }
body::-webkit-scrollbar-track{ background:#111; }
body::-webkit-scrollbar-thumb{ background:#474747; border-radius:6px; }
body::-webkit-scrollbar-thumb:hover{ background:#595959; }

/* Root grid */
#grid{
  display:grid;
  /* left | gap | middle | gap | far-right (resizable) */
  grid-template-columns: var(--col-left) var(--gap) 1fr var(--gap) minmax(260px, var(--col-help));
  grid-template-rows: var(--row-top) var(--gap) 1fr;
  height:100dvh;
  min-height:100svh;
  width:100%;
}

.hidden{ display:none !important; }

/* =========================================
   Panels (header fixed, body scrolls)
   ========================================= */
.panel{
  position:relative;
  display:grid;
  grid-template-rows: auto 1fr;  /* header | scrollable body */
  min-height:0;
  overflow:hidden;               /* outer never scrolls */
  border:1px solid var(--edge);
  border-radius:var(--radius);
  background:var(--bg-820);
}

/* Scrollable body */
.panel > .panel-body{
  min-height:0;
  overflow:auto;
  padding:12px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: #474747 #111;
}
.panel > .panel-body::-webkit-scrollbar{ width:10px; height:10px; }
.panel > .panel-body::-webkit-scrollbar-track{ background:#111; }
.panel > .panel-body::-webkit-scrollbar-thumb{ background:#474747; border-radius:6px; }
.panel > .panel-body::-webkit-scrollbar-thumb:hover{ background:#595959; }

.panel-header{
  position:sticky; /* header stays visible above scroller */
  height: 45px;
  top:0;
  z-index:2;
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 14px;
  background:var(--bg-850);
  border-bottom:1px solid var(--edge);
}
.panel-title{
  font-weight:700;
  text-transform:uppercase;
  font-size:0.8rem;
  color:var(--text);
}

/* Flat backgrounds for Help & Bottom */
#taskHelp, #bottomPanel{ background:var(--bg-820); }

/* --- Accent panels --- */
#challengePanel{
  background:var(--bg-820);
  border-color:var(--accent-challenge);
}
#challengePanel .panel-header{
  background:var(--bg-850);
  border-bottom-color:var(--edge);
}
#challengePanel .panel-title{ color:var(--accent-challenge); }

#agentPanel{
  background:var(--bg-820);
  border-color:var(--accent-agent);

  /* header | history (scroll) | input (fixed) */
  display:grid;
  grid-template-rows:auto 1fr auto;
  min-height:0;
}
/* history area: the scroller */
#agentPanel > .panel-body:first-of-type{
  min-height:0;
  overflow:auto;
}
/* input area: fixed, no scroll */
#agentPanel > .panel-body:last-of-type{
  overflow:visible;
}

/* Gear visibility and animation control */
.panel .panel-header .gear{ display:none; }
.panel[data-loading="true"] .panel-header .gear{ display:inline-block; }
.panel .panel-header .gear.spin{ animation:none; }
.panel[data-loading="true"] .panel-header .gear.spin{ animation:spin 1.2s linear infinite; }

/* Challenge meta pill */
.challenge-meta{ margin-left:8px; display:flex; align-items:center; gap:8px; }
.pill{
  display:inline-flex; align-items:center; gap:8px;
  font-family:var(--mono);
  font-size:.85rem;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--accent-challenge);
  background:#141414;
  color:var(--accent-challenge);
}

/* Controls */
.gear{ width:18px; height:18px; opacity:.9; }
.spin{ animation:spin 1.2s linear infinite; }
@keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360)} }

.btn{
  cursor:pointer;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid var(--edge-strong);
  background:var(--bg-850);
  color:var(--text);
  font-weight:600;
  transition:background .15s;
  min-height:40px;        /* phone touch target */
  min-width:44px;         /* phone touch target */
  touch-action:manipulation;
}
.btn:hover{ background:#222; }
.btn.ghost{ background:transparent; color:var(--text-dim); border-color:var(--edge); }
.btn.small{ padding:6px 10px; font-size:.92rem; }
.row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
/* keep specific rows unwrapped when needed */
.row.nowrap{ flex-wrap:nowrap; }
.grow{ flex:1 1 auto; }

/* ---------- Agent mode segmented toggle ---------- */
.seg{
  display:inline-flex;
  border:1px solid var(--edge-strong);
  border-radius:10px;
  overflow:hidden;
  background:#0f0f0f;
}
.seg-btn{
  cursor:pointer;
  padding:6px 10px;
  min-height:30px;
  border:0;
  background:transparent;
  color:var(--text-dim);
  font-family:var(--mono);
  font-size:.78rem;
  font-weight:800;
}
.seg-btn:hover{ background:#1a1a1a; color:var(--text); }
.seg-btn.active{ background:#1e2a46; color:#cfe7ff; }

/* Inputs */
input[type="text"], textarea, select{
  width:100%;
  padding:10px 12px;
  border-radius:6px;
  background:#111;
  border:1px solid var(--edge);
  color:var(--text);
  font-family:var(--mono);
  font-size: clamp(0.95rem, 0.7rem + 0.6vw, 1.06rem);
}
textarea{ resize:vertical; min-height:64px; line-height:1.5; }
select{ background:#111; color:var(--text); }
option{ background:#111; color:var(--text); }
.hint{ color:var(--text-dim); font-style:italic; }

/* Handy monospace + keycap styles */
.mono{ font-family:var(--mono); }
kbd{
  display:inline-block; padding:2px 6px; border-radius:4px;
  border:1px solid var(--edge); background:#111; color:var(--text);
  box-shadow:inset 0 -1px 0 rgba(255,255,255,.03);
  font-family:var(--mono); font-size:.9em;
}

/* Connection LED */
.led{
  width:10px; height:10px; border-radius:50%;
  display:inline-block; margin-left:8px;
  background:#4b4b4b; box-shadow:0 0 0 1px var(--edge) inset;
}
.led.ok{
  background:#22c55e; box-shadow:0 0 0 1px #0f3a21 inset, 0 0 8px rgba(34,197,94,.7);
}
.led.off{
  background:#5b5b5b; box-shadow:0 0 0 1px var(--edge) inset;
}
.led.reconnecting{
  background:#facc15; box-shadow:0 0 0 1px #6b5400 inset, 0 0 8px rgba(250,204,21,.6);
  animation:ledblink 1.2s ease-in-out infinite;
}
@keyframes ledblink{ 0%,55%{opacity:.35} 100%{opacity:1} }

/* Zh rendering */
ruby.zh{ ruby-position:over; }
ruby.zh rt{ font-size:.68em; line-height:1; opacity:.9; }
.zh{
  font-size: clamp(1.35rem, 1rem + 3.2vw, 2.25rem);
  line-height:1.6;
}
#challengeEn{ color:var(--text-dim); margin-top:4px; }

/* --- Unified Task layout (rightTop) --- */
#rightTop{
  display:flex;      /* constrain child panel for inner scroll */
  height:100%;
  min-height:0;
}
#rightTop > section.panel{
  flex:1 1 auto;
  min-height:0;
}

/* Answer bar: grid so the input can be huge, buttons can drop under */
#answerBar{
  position: sticky;
  top: 0;
  z-index: 3;
  display:grid;
  grid-template-columns: 1fr auto;   /* input | buttons (desktop) */
  gap:6px;
  align-items:stretch;
  background:#101010;
  border:1px solid var(--edge);
  border-radius:8px;
  padding:6px;
  margin-bottom:10px;
}
#answerForm{ grid-column: 1 / 2; }
#answerInput{
  font-size: clamp(1.1rem, 1rem + 1.2vw, 1.5rem);
  line-height:1.5;
  min-height:52px;
}
/* Buttons stacked vertically (saves horizontal space) */
.btn-group{
  grid-column: 2 / 3;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:6px;
}

/* Feedback chip (collapsible, no phantom gap) */
#answerFeedback{
  font-size:.92rem;
  border-radius:6px;
  padding:0 10px;
  border:1px solid transparent;
  opacity:0;
  max-height:0;
  overflow:hidden;
  margin-top:0;
  transition: opacity .2s, max-height .25s ease, margin .2s, padding .2s;
}
#answerFeedback.show{ opacity:1; max-height:220px; margin-top:6px; padding:8px 10px; }
#answerFeedback.ok{
  border-color:var(--accent-challenge);
  background:#0f1712;
  color:#a9eec6;
}
#answerFeedback.err{
  border-color:#ef4444;
  background:#1a0f10;
  color:#ffc7c7;
}
#answerFeedback strong{ font-weight:800; margin-right:.4em; }

/* Task content (Help moved to far-right column) */
#taskGrid{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
  align-items:start;
}
@media (max-width: 980px){
  #taskGrid{ grid-template-columns: 1fr; }
}

/* Section labels in the panel body */
.section-label{
  color:var(--text-dim);
  font-size:.82rem;
  letter-spacing:.04em;
  text-transform:uppercase;
  margin-bottom:4px;
}

/* Help & Hints & Settings panel internals */
#hintsBlock .intro{
  color:#d7ffd7;
  background:#0d1812;
  border:1px solid #1e3a2f;
  padding:8px 10px;
  border-radius:6px;
  font-size:.92rem;
}
.hints{
  list-style:none; padding:0; margin:10px 0 0 0;
  display:flex; flex-direction:column; gap:6px;
}
.hint-item{
  background:#101010;
  border:1px solid var(--edge);
  border-left:3px solid var(--accent-challenge);
  border-radius:6px;
  padding:8px 10px;
  font-size:.95rem;
}
.hint-item small{
  display:block; color:var(--text-dim);
  font-size:.72rem; letter-spacing:.04em; margin-bottom:2px;
}

/* Assistance rows */
.kv{ display:grid; gap:6px; }
.kv-row{
  background:#0f0f0f; border:1px dashed #2b2b2b; border-radius:6px;
  padding:8px 10px;
}
.kv-row .subtle{ color:var(--text-dim); font-size:.78rem; margin-bottom:2px; }

/* Grammar correction diff styles */
.gc-box{ 
  background:#0e0e0e;
  border:1px solid #252525;
  border-radius:6px;
  padding:6px 8px;
}
.gc-row{
  display:grid; 
  grid-template-columns: 1fr 2fr; 
  gap:8px; 
  align-items:flex-start;
  margin:2px 0;
}
.gc-label{
  color:#b4b4b4;
  font-size:.78rem;
  letter-spacing:.02em;
  padding-top:2px;
}
.gc-line{
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.55;
}
.gc-ins{ color:var(--accent-challenge); background:#0f1712; padding:0 1px; border-radius:2px; }
.gc-del{ color:#ff9d9d; text-decoration:line-through; background:#1a0f10; padding:0 1px; border-radius:2px; }
.gc-legend{
  margin-top:6px; 
  color:var(--text-dim);
  font-size:.76rem;
}
.gc-legend .sw{ display:inline-block; width:10px; height:10px; border-radius:2px; vertical-align:middle; margin:-2px 4px 0 8px; }
.gc-legend .sw.add{ background:#0f1712; border:1px solid #1e3a2f; }
.gc-legend .sw.del{ background:#1a0f10; border:1px solid #3b1f1f; }

/* Make the log fill up to ~half of the viewport, still with a floor and ceiling */
#eventLog{
  max-height: clamp(380px, 50vh, 900px);
  min-height: 260px;
}
#eventLog .log-item{
  display:flex; align-items:flex-start; gap:6px;
  padding:6px 8px; margin:2px 0;
  font-size:0.75rem;
  background:#111; border-left:4px solid #444; border-radius:4px;
}
#eventLog .log-info{ border-left-color:#3ea8ff; }
#eventLog .log-success{ border-left-color:#22c55e; }
#eventLog .log-warn{ border-left-color:#facc15; }
#eventLog .log-error{ border-left-color:#ef4444; }
#eventLog .ts{ color:var(--text-dim); flex:0 0 auto; min-width:74px; }
#eventLog .txt{ white-space:pre-wrap; }

/* --- Agent chat bubbles --- */
#agentHistory{
  display:flex; flex-direction:column; gap:14px;
  padding-right:4px;
}
#agentHistory .msg{
  max-width: 88%;
  padding:10px 12px;
  border-radius:12px;
  position:relative;
  white-space:pre-wrap;
  word-break:break-word;
}
#agentHistory .msg.agent{
  align-self:flex-start;
  background:#0f1720;
  border:1px solid #2a3b4e;
  color:#cfe7ff;
  box-shadow: 0 1px 0 #0a1017 inset;
}
#agentHistory .msg.user{
  align-self:flex-end;
  background:#1b1b1b;
  border:1px solid #3a3a3a;
  color:#ffffff;
  box-shadow: 0 1px 0 #101010 inset;
}
#agentHistory .msg.agent::before{
  content: attr(data-label);
  position:absolute; top:-14px; left:6px;
  font-size:.70rem; color:var(--text-dim);
  letter-spacing:.02em;
}
#agentHistory .msg.user::before{
  content: attr(data-label);
  position:absolute; top:-14px; right:6px;
  font-size:.70rem; color:var(--text-dim);
  letter-spacing:.02em;
}

/* Resizers */
.v-resizer, .h-resizer{ background:#2f2f2f; }
.v-resizer{ cursor:col-resize; }
.h-resizer{ cursor:row-resize; }

/* Grid placement (desktop) */
#agentPanel{ grid-column:1/2; grid-row:1/2; }
#vr{ grid-column:2/3; grid-row:1/2; }               /* left <-> middle */
#rightTop{ grid-column:3/4; grid-row:1/2; }         /* middle (task) */
#vrRight{ grid-column:4/5; grid-row:1/4; }          /* middle <-> far-right (full height) */
#taskHelp{ grid-column:5/6; grid-row:1/4; }         /* far-right: Help + Settings continuous */
#hr{ grid-column:1/5; grid-row:2/3; }               /* top/bottom divider (NOT crossing far-right) */
#bottomPanel{ grid-column:1/5; grid-row:3/4; }      /* bottom: left + middle only */

/* Removed the old internal splitter */
/* #hrRight no longer used */

/* ---------- Compact buttons just in Challenge panel ---------- */
#challengePanel .btn.small{ padding:4px 8px; min-height:30px; font-size:.86rem; }
#challengePanel .btn-group{ gap:6px; }

/* Corner favicon (top-right) */
#cornerFavicon{
  position:fixed;
  top:0px; right:10px;
  width:50px; height:50px;
  z-index:1000;
  opacity:.9;
}
#cornerFavicon img{ width:100%; height:100%; display:block; }

/* =========================
   Responsive tweaks
   =========================*/

/* Buttons under the input once width tightens a bit */
@media (max-width: 1280px){
  #answerBar{
    grid-template-columns: 1fr;         /* stack input then buttons column */
  }
  .btn-group{
    grid-column: 1 / -1;                /* full row under input */
  }
}

/* Mobile optimizations */
@media (max-width: 880px){

  /* Stack app into one column */
  #grid{
    grid-template-columns: 1fr;
    /* task | gap | agent | gap | help+settings | gap | log */
    grid-template-rows: auto var(--gap) auto var(--gap) auto var(--gap) auto;
    height:auto;
    min-height:100svh;
  }

  /* Order */
  #rightTop{ grid-column:1/2; grid-row:1/2; }
  #hr{ grid-column:1/2; grid-row:2/3; height:var(--gap); }
  #agentPanel{ grid-column:1/2; grid-row:3/4; }
  #taskHelp{ grid-column:1/2; grid-row:5/6; }
  #bottomPanel{ grid-column:1/2; grid-row:7/8; }

  /* Hide vertical resizers on mobile */
  #vr, #vrRight{ display:none !important; }

  .panel-header{ padding:8px 10px; gap:8px; }
  .panel > .panel-body{ padding:10px; }

  #agentHistory .msg{ max-width: 96%; }

  /* Buttons: already vertical; keep touch-friendly */
  .btn-group .btn.small{
    width: 100%;
  }

  /* Labels / pills a bit tighter */
  .pill{ padding:5px 8px; font-size:.82rem; }
  .section-label{ font-size:.78rem; }

  /* Event log still sizable on phones */
  #eventLog{ max-height: 50vh; min-height: 220px; }
}

@media (max-width: 440px){
  .panel-header{ padding:6px 8px; }
  .panel > .panel-body{ padding:8px; }
  #answerInput{ min-height:48px; }
  #eventLog{ max-height: 50vh; min-height: 180px; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .spin{ animation:none !important; }
  .led.reconnecting{ animation:none !important; }
}

/* =========================
   Nested scroll enablers
   =========================*/
#grid, #agentPanel, #rightTop, #bottomPanel, #taskHelp { min-height: 0; }
#challengePanel .panel-body{ position: relative; }

/* --- Compact Difficulty select --- */
#settingsGrid #difficultySel{
  padding: 3px 8px;
  height: 25px;              /* explicit height for consistent compact look */
  line-height: 1.2;
  font-size: .85rem;
}
#settingsGrid label.row.nowrap > span{ font-size: .85rem; }

/* --- Event log header compact --- */
#eventLogControls{ margin-bottom: 4px; padding: 0; }
#eventLogControls strong{ font-size: .9rem; font-weight: 600; }
#eventLogControls .btn.small{ padding: 3px 6px; min-height: 26px; font-size: .8rem; }

/* ===================================================================
   Answer actions: improved layout, icon, and distinct colors
   =================================================================== */

/* Always put buttons under the input (all widths) */
#answerBar{
  grid-template-columns: 1fr;                 /* single column: input then buttons */
}
#answerBar .btn-group{
  grid-column: 1 / -1;
  display: grid;                              /* override earlier flex */
  gap: 6px;
  grid-template-columns: repeat(auto-fit, minmax(96px, max-content));
  justify-content: end;                       /* right-align on wide screens */
  align-items: stretch;
}

/* Distinct colors for Submit (emerald) and Next (azure) */
#answerSendBtn{
  background:#1d2e24;
  border-color:#1e3a2f;
  color:#a9eec6;
}
#answerSendBtn:hover{ background:#122017; }

#newChallengeBtn{
  background:#1e2a46;
  border-color:#2a3b4e;
  color:#cfe7ff;
}
#newChallengeBtn:hover{ background:#121a26; }

/* Mobile: 3-col grid (then 2-col on very small). Submit spans 2 cols. */
@media (max-width: 880px){
  #answerBar .btn-group{
    grid-template-columns: repeat(3, minmax(0, 1fr));
    justify-content: stretch;
  }
  #answerBar .btn-group .btn.small{
    width:auto;                 /* override earlier 100% width */
    min-height:36px;
  }
  #answerSendBtn{
    grid-column: span 2;        /* make primary easy to hit */
  }
}
@media (max-width: 440px){
  #answerBar .btn-group{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

:root{
  /* Layout */
  --gap: 3px;
  --col-left: 25%;
  --row-top: 75vh;
  --right-split: 52%;
  --col-help: 26%;
  --radius: 2px;

  /* Typography */
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

  /* Motion */
  --dur-fast: .15s;
  --dur-med: .22s;
}

/* Base palette: refined (default + only style preset) */
body{
  --c-bg-page:#060809;
  --c-bg-panel:#11161a;
  --c-bg-header:#0d1216;
  --c-surface-1:#0d1114;
  --c-surface-2:#101820;
  --c-surface-3:#131920;
  --c-border:#24303a;
  --c-border-strong:#334450;
  --c-text:#e7edf3;
  --c-text-dim:#8f9ca9;
  --c-scroll-track:#0b1014;
  --c-scroll-thumb:#355062;
  --c-scroll-thumb-hover:#416276;
  --c-accent-challenge:#41c97a;
  --c-accent-agent:#44a7ff;
  --c-accent-submit-bg:#1a3327;
  --c-accent-submit-border:#25533c;
  --c-accent-submit-text:#b8f4d1;
  --c-accent-next-bg:#1d3047;
  --c-accent-next-border:#2f4b67;
  --c-accent-next-text:#cde7ff;
  --c-label-soft:#7b8897;
  --c-modal-overlay:rgba(3,8,12,.72);
  --c-modal-card:#111820;
  --c-modal-border:#2b3a48;
  --c-panel-scroll-track:#0b1014;
  --c-panel-scroll-thumb:#355062;
  --c-panel-scroll-thumb-hover:#416276;
  --c-pill-bg:#141b20;
  --c-btn-hover:#1a2229;
  --c-seg-bg:#0f151a;
  --c-seg-hover:#19252f;
  --c-seg-active-bg:#203346;
  --c-seg-active-text:#cde7ff;
  --c-input-bg:#0f161c;
  --c-kbd-bg:#0e1418;
  --c-led-off:#55616b;
  --c-led-idle:#404a52;
  --c-led-reconnect:#f0be2f;
  --c-soft-label:#95a2af;
  --c-feedback-ok-bg:#0f1f18;
  --c-feedback-ok-text:#b5f0cf;
  --c-feedback-err-bg:#261315;
  --c-feedback-err-text:#ffc7c7;
  --c-help-intro-bg:#102018;
  --c-help-intro-text:#d6ffe6;
  --c-help-intro-border:#275442;
  --c-card-bg:#10161b;
  --c-dash-border:#2b3844;
  --c-gc-bg:#0d1318;
  --c-gc-border:#2a3945;
  --c-gc-label:#adbac7;
  --c-gc-add-bg:#102118;
  --c-gc-add-border:#28543f;
  --c-gc-del-bg:#2a1518;
  --c-gc-del-border:#4c2429;
  --c-event-item-bg:#0f151a;
  --c-event-item-border:#4a5966;
  --c-bubble-agent-bg:#122132;
  --c-bubble-agent-border:#34516b;
  --c-bubble-agent-text:#d5eaff;
  --c-bubble-agent-inset:#0d1824;
  --c-bubble-user-bg:#1b1f24;
  --c-bubble-user-border:#3b444d;
  --c-bubble-user-text:#f0f6ff;
  --c-bubble-user-inset:#11161b;
  --c-resizer:#34424f;
  --c-submit-hover:#153022;
  --c-next-hover:#152738;
  --c-modal-title:#dce5ef;
  --c-modal-copy:#9fa9b3;
}

/* Theme override: light */
body[data-theme="light"]{
  --c-bg-page:#f3f6fa;
  --c-bg-panel:#ffffff;
  --c-bg-header:#eef3f8;
  --c-surface-1:#f6f9fd;
  --c-surface-2:#f4f8fc;
  --c-surface-3:#eef3f8;
  --c-border:#cfd8e3;
  --c-border-strong:#b8c5d3;
  --c-text:#1f2a36;
  --c-text-dim:#5f6f81;
  --c-scroll-track:#e7edf4;
  --c-scroll-thumb:#b8c6d6;
  --c-scroll-thumb-hover:#a6b8cb;
  --c-accent-challenge:#2fa85f;
  --c-pill-bg:#f1f6fb;
  --c-btn-hover:#e7edf4;
  --c-seg-bg:#eaf0f7;
  --c-seg-hover:#dde7f2;
  --c-seg-active-bg:#d6e4f5;
  --c-seg-active-text:#1e3a5f;
  --c-input-bg:#ffffff;
  --c-kbd-bg:#f3f7fc;
  --c-led-off:#8fa0b3;
  --c-led-idle:#8092a6;
  --c-led-reconnect:#c7a63a;
  --c-label-soft:#708298;
  --c-feedback-ok-bg:#e9f7ef;
  --c-feedback-ok-text:#1f6a43;
  --c-feedback-err-bg:#fdeeee;
  --c-feedback-err-text:#8b2f2f;
  --c-help-intro-bg:#eaf8f0;
  --c-help-intro-text:#235b3f;
  --c-help-intro-border:#9fcab0;
  --c-card-bg:#f8fbff;
  --c-dash-border:#c6d3e1;
  --c-gc-bg:#f8fbff;
  --c-gc-border:#c8d4e2;
  --c-gc-label:#5f6f81;
  --c-gc-add-bg:#e8f5ec;
  --c-gc-add-border:#9fcab0;
  --c-gc-del-bg:#fdeeee;
  --c-gc-del-border:#e0b1b1;
  --c-event-item-bg:#f7fbff;
  --c-event-item-border:#9aaabd;
  --c-bubble-agent-bg:#eaf3ff;
  --c-bubble-agent-border:#a9c2df;
  --c-bubble-agent-text:#1f3c5d;
  --c-bubble-agent-inset:#dce9f7;
  --c-bubble-user-bg:#f1f4f8;
  --c-bubble-user-border:#c5cfda;
  --c-bubble-user-text:#253343;
  --c-bubble-user-inset:#e6ecf3;
  --c-resizer:#c3cfdb;
  --c-submit-hover:#d9efdf;
  --c-next-hover:#d8e7f7;
  --c-modal-overlay:rgba(67,82,101,.28);
  --c-modal-card:#ffffff;
  --c-modal-border:#c8d4e2;
  --c-modal-title:#203040;
  --c-modal-copy:#5f6f81;
}

/* Compatibility aliases for existing rules */
body{
  --bg-900:var(--c-bg-page);
  --bg-850:var(--c-bg-header);
  --bg-820:var(--c-bg-panel);
  --edge:var(--c-border);
  --edge-strong:var(--c-border-strong);
  --text:var(--c-text);
  --text-dim:var(--c-text-dim);
  --accent-challenge:var(--c-accent-challenge);
  --accent-agent:var(--c-accent-agent);

  /* Tones */
  --tone1:#ef4444; --tone2:#facc15; --tone3:#22c55e; --tone4:#3ea8ff; --tone5:#a4b0be;
}

*,*::before,*::after{ box-sizing:border-box; }
[hidden]{ display:none !important; }
html{ height:100%; -webkit-text-size-adjust:100%; }
body{
  height:100%;
  margin:0;
  position:relative;
  font-family: var(--mono);
  color:var(--text);
  background: var(--bg-900);
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  scrollbar-width: thin;
  scrollbar-color: var(--c-scroll-thumb) var(--c-scroll-track);
  /* mobile safe area */
  padding-bottom: env(safe-area-inset-bottom, 0px);
  overscroll-behavior-y: contain;
}
body::-webkit-scrollbar{ width:12px; height:12px; }
body::-webkit-scrollbar-track{ background:var(--c-scroll-track); }
body::-webkit-scrollbar-thumb{ background:var(--c-scroll-thumb); border-radius:6px; }
body::-webkit-scrollbar-thumb:hover{ background:var(--c-scroll-thumb-hover); }

body::before{
  content:"";
  position:fixed;
  inset:-22vmax;
  pointer-events:none;
  z-index:-1;
  background:
    radial-gradient(42vmax 42vmax at 14% 12%, color-mix(in srgb, var(--accent-agent) 16%, transparent), transparent 70%),
    radial-gradient(38vmax 38vmax at 88% 0%, color-mix(in srgb, var(--accent-challenge) 14%, transparent), transparent 74%),
    radial-gradient(30vmax 30vmax at 50% 95%, color-mix(in srgb, var(--accent-agent) 10%, transparent), transparent 78%);
  opacity:.66;
}
body[data-theme="light"]::before{
  opacity:.35;
}

/* Root grid */
#grid{
  display:grid;
  /* left | gap | middle | gap | far-right (resizable) */
  grid-template-columns: var(--col-left) var(--gap) 1fr var(--gap) minmax(260px, var(--col-help));
  grid-template-rows: var(--row-top) var(--gap) 1fr;
  height:100dvh;
  min-height:100svh;
  width:100%;
}

.hidden{ display:none !important; }

/* =========================================
   Panels (header fixed, body scrolls)
   ========================================= */
.panel{
  position:relative;
  display:grid;
  grid-template-rows: auto 1fr;  /* header | scrollable body */
  min-height:0;
  overflow:hidden;               /* outer never scrolls */
  border:1px solid var(--edge);
  border-radius:var(--radius);
  background:var(--bg-820);
}

/* Scrollable body */
.panel > .panel-body{
  min-height:0;
  overflow:auto;
  padding:12px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--c-panel-scroll-thumb) var(--c-panel-scroll-track);
}
.panel > .panel-body::-webkit-scrollbar{ width:10px; height:10px; }
.panel > .panel-body::-webkit-scrollbar-track{ background:var(--c-panel-scroll-track); }
.panel > .panel-body::-webkit-scrollbar-thumb{ background:var(--c-panel-scroll-thumb); border-radius:6px; }
.panel > .panel-body::-webkit-scrollbar-thumb:hover{ background:var(--c-panel-scroll-thumb-hover); }

.panel-header{
  position:sticky; /* header stays visible above scroller */
  height: 38px;
  top:0;
  z-index:2;
  display:flex;
  align-items:center;
  gap:10px;
  padding:4px 10px;
  background:var(--bg-850);
  border-bottom:1px solid var(--edge);
}
.panel-title{
  font-weight:700;
  text-transform:uppercase;
  font-size:0.74rem;
  color:var(--text);
}

/* Flat backgrounds for Help & Bottom */
#taskHelp, #bottomPanel{ background:var(--bg-820); }

/* --- Accent panels --- */
#challengePanel{
  background:var(--bg-820);
  border-color:var(--accent-challenge);
}
#challengePanel .panel-header{
  background:var(--bg-850);
  border-bottom-color:var(--edge);
}
#challengePanel .panel-title{ color:var(--accent-challenge); }

#agentPanel{
  background:var(--bg-820);
  border-color:var(--accent-agent);

  /* header | history (scroll) | input (fixed) */
  display:grid;
  grid-template-rows:auto 1fr auto;
  min-height:0;
}
/* history area: the scroller */
#agentPanel > .panel-body:first-of-type{
  min-height:0;
  overflow:auto;
}
/* input area: fixed, no scroll */
#agentPanel > .panel-body:last-of-type{
  overflow:visible;
}

/* Gear visibility and animation control */
.panel .panel-header .gear{ display:none; }
.panel[data-loading="true"] .panel-header .gear{ display:inline-block; }
.panel .panel-header .gear.spin{ animation:none; }
.panel[data-loading="true"] .panel-header .gear.spin{ animation:spin 1.2s linear infinite; }

/* Challenge meta pill */
.challenge-meta{ margin-left:8px; display:flex; align-items:center; gap:8px; }
.pill{
  display:inline-flex; align-items:center; gap:8px;
  font-family:var(--mono);
  font-size:.85rem;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--accent-challenge);
  background:var(--c-pill-bg);
  color:var(--accent-challenge);
}

/* Controls */
.gear{ width:18px; height:18px; opacity:.9; }
.spin{ animation:spin 1.2s linear infinite; }
@keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360)} }

.btn{
  cursor:pointer;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid var(--edge-strong);
  background:var(--bg-850);
  color:var(--text);
  font-weight:600;
  transition:background .15s;
  min-height:40px;        /* phone touch target */
  min-width:44px;         /* phone touch target */
  touch-action:manipulation;
}
.btn:hover{ background:var(--c-btn-hover); }
.btn.ghost{ background:transparent; color:var(--text-dim); border-color:var(--edge); }
.btn.small{ padding:6px 10px; font-size:.92rem; }
.row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
/* keep specific rows unwrapped when needed */
.row.nowrap{ flex-wrap:nowrap; }
.grow{ flex:1 1 auto; }

.agent-form{ display:block; }
.agent-input-wrap{ position:relative; }
#agentInput{
  padding-right:90px;
  min-height:56px;
}
#agentSendBtn{
  position:absolute;
  right:6px;
  top:6px;
  min-height:30px;
  min-width:34px;
  padding:4px 6px;
  font-size:.9rem;
}

/* ---------- Agent mode segmented toggle ---------- */
.seg{
  display:inline-flex;
  border:1px solid var(--edge-strong);
  border-radius:10px;
  overflow:hidden;
  background:var(--c-seg-bg);
}
.seg-btn{
  cursor:pointer;
  padding:4px 8px;
  min-height:26px;
  border:0;
  background:transparent;
  color:var(--text-dim);
  font-family:var(--mono);
  font-size:.72rem;
  font-weight:800;
}
.seg-btn:hover{ background:var(--c-seg-hover); color:var(--text); }
.seg-btn.active{ background:var(--c-seg-active-bg); color:var(--c-seg-active-text); }

/* Inputs */
input[type="text"], textarea, select{
  width:100%;
  padding:10px 12px;
  border-radius:6px;
  background:var(--c-input-bg);
  border:1px solid var(--edge);
  color:var(--text);
  font-family:var(--mono);
  font-size: clamp(0.95rem, 0.7rem + 0.6vw, 1.06rem);
}
textarea{ resize:vertical; min-height:64px; line-height:1.5; }
select{ background:var(--c-input-bg); color:var(--text); }
option{ background:var(--c-input-bg); color:var(--text); }
.hint{ color:var(--text-dim); font-style:italic; }
.hint.subtle{ font-size:.74rem; line-height:1.25; }

/* Handy monospace + keycap styles */
.mono{ font-family:var(--mono); }
kbd{
  display:inline-block; padding:2px 6px; border-radius:4px;
  border:1px solid var(--edge); background:var(--c-kbd-bg); color:var(--text);
  box-shadow:inset 0 -1px 0 rgba(255,255,255,.03);
  font-family:var(--mono); font-size:.9em;
}

/* Connection LED */
.led{
  width:10px; height:10px; border-radius:50%;
  display:inline-block; margin-left:8px;
  background:var(--c-led-idle); box-shadow:0 0 0 1px var(--edge) inset;
}
.led.ok{
  background:var(--accent-challenge); box-shadow:0 0 0 1px var(--c-help-intro-border) inset, 0 0 8px rgba(34,197,94,.7);
}
.led.off{
  background:var(--c-led-off); box-shadow:0 0 0 1px var(--edge) inset;
}
.led.reconnecting{
  background:var(--c-led-reconnect); box-shadow:0 0 0 1px #6b5400 inset, 0 0 8px rgba(250,204,21,.6);
  animation:ledblink 1.2s ease-in-out infinite;
}
@keyframes ledblink{ 0%,55%{opacity:.35} 100%{opacity:1} }

/* Zh rendering */
ruby.zh{ ruby-position:over; }
ruby.zh rt{ font-size:.68em; line-height:1; opacity:.9; }
.zh{
  font-size: clamp(1.05rem, 0.9rem + 1.2vw, 1.45rem);
  line-height:1.6;
}
#challengeEn{
  color:var(--text-dim);
  margin-top:6px;
  white-space:pre-line;
  line-height:1.45;
}
#challengeEn .en-line{ margin:2px 0; }
#challengeEn .en-label{
  color:var(--c-label-soft);
  font-size:.84em;
  letter-spacing:.02em;
  margin-right:6px;
}

/* --- Unified Task layout (rightTop) --- */
#rightTop{
  display:flex;      /* constrain child panel for inner scroll */
  height:100%;
  min-height:0;
}
#rightTop > section.panel{
  flex:1 1 auto;
  min-height:0;
}

/* Answer bar: grid so the input can be huge, buttons can drop under */
#answerBar{
  position: sticky;
  top: 0;
  z-index: 3;
  display:grid;
  grid-template-columns: 1fr auto;   /* input | buttons (desktop) */
  gap:6px;
  align-items:stretch;
  background:var(--c-surface-2);
  border:1px solid var(--edge);
  border-radius:8px;
  padding:6px;
  margin-bottom:10px;
}
#answerForm{ grid-column: 1 / 2; }
#answerInput{
  font-size: clamp(1.1rem, 1rem + 1.2vw, 1.5rem);
  line-height:1.5;
  min-height:52px;
  font-family:
    "Noto Sans SC",
    "PingFang SC",
    "Hiragino Sans GB",
    "Microsoft YaHei",
    "Source Han Sans SC",
    "WenQuanYi Micro Hei",
    "Noto Sans CJK SC",
    sans-serif;
  font-weight: 500;
  letter-spacing: 0;
}
/* Buttons stacked vertically (saves horizontal space) */
.btn-group{
  grid-column: 2 / 3;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:6px;
}

/* Feedback chip (collapsible, no phantom gap) */
#answerFeedback{
  font-size:.92rem;
  border-radius:6px;
  padding:0 10px;
  border:1px solid transparent;
  opacity:0;
  max-height:0;
  overflow:hidden;
  overflow-wrap:anywhere;
  word-break:break-word;
  margin-top:0;
  transition: opacity .2s, max-height .25s ease, margin .2s, padding .2s;
}
#answerFeedback.show{ opacity:1; max-height:220px; margin-top:6px; padding:8px 10px; }
#answerFeedback.ok{
  border-color:var(--accent-challenge);
  background:var(--c-feedback-ok-bg);
  color:var(--c-feedback-ok-text);
}
#answerFeedback.err{
  border-color:#ef4444;
  background:var(--c-feedback-err-bg);
  color:var(--c-feedback-err-text);
}
#answerFeedback strong{ font-weight:800; margin-right:.4em; }

.challenge-loading{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin:6px 0 10px;
  min-height:210px;
  padding:14px 12px;
  border:1px solid var(--accent-challenge);
  border-radius:8px;
  color:var(--text-dim);
  background:color-mix(in srgb, var(--accent-challenge) 10%, transparent);
  text-align:center;
}
.challenge-loading-logo{
  width:88px;
  height:88px;
  object-fit:contain;
  opacity:.95;
  animation:challengeLogoPulse 1.1s ease-in-out infinite;
}
.challenge-loading-text{
  font-size:.9rem;
  letter-spacing:.04em;
  color:var(--text-dim);
}
@keyframes challengeLogoPulse{
  0%, 100% { transform:scale(.95); opacity:.75; }
  50% { transform:scale(1.02); opacity:1; }
}

/* Task content (Help moved to far-right column) */
#taskGrid{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
  align-items:start;
}
@media (max-width: 980px){
  #taskGrid{ grid-template-columns: 1fr; }
}

/* Section labels in the panel body */
.section-label{
  color:var(--text-dim);
  font-size:.82rem;
  letter-spacing:.04em;
  text-transform:uppercase;
  margin-bottom:4px;
}
.section-label-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.section-label-row .btn.small{
  min-height:34px;
  font-size:.9rem;
  padding:5px 10px;
  text-transform:none;
}

/* Settings block */
#settingsGrid{
  display:grid;
  grid-template-columns:1fr;
  gap:6px;
}
#settingsGrid label.row{
  margin:0;
  min-height:28px;
}
#settingsGrid label.row.nowrap > span,
#settingsGrid label.row > span{
  color:var(--text-dim);
  font-size:.82rem;
  line-height:1.2;
  min-width:76px;
}
#settingsGrid .toggle{
  display:flex;
  align-items:center;
  gap:6px;
  margin:0;
  color:var(--text);
  font-size:.82rem;
  line-height:1.2;
}
#settingsGrid .toggle input[type="checkbox"]{
  width:14px;
  height:14px;
  margin:0;
  flex:0 0 auto;
}
#settingsGrid select{
  height:28px;
  padding:3px 7px;
  line-height:1.2;
  font-size:.84rem;
}
#settingsGrid .grow{
  border-radius:4px;
}
#settingsGrid #ttsVoiceSel{
  font-size:.8rem;
}
#settingsGrid #ttsRate{
  height:28px;
  padding:0;
}
#settingsGrid #ttsRateVal{
  color:var(--text-dim);
  font-size:.82rem;
}

#toggleSettingsBtn{
  min-height:34px !important;
  min-width:38px;
  padding:0 10px !important;
  font-size:1.18rem !important;
  line-height:1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
}

#agentResetBtn{
  min-height:28px;
  padding:3px 7px;
  border-width:1px;
}

/* Help & Hints & Settings panel internals */
#hintsBlock .intro{
  color:var(--c-help-intro-text);
  background:var(--c-help-intro-bg);
  border:1px solid var(--c-help-intro-border);
  padding:8px 10px;
  border-radius:6px;
  font-size:.92rem;
}
.hints{
  list-style:none; padding:0; margin:10px 0 0 0;
  display:flex; flex-direction:column; gap:6px;
}
.hint-item{
  background:var(--c-card-bg);
  border:1px solid var(--edge);
  border-left:3px solid var(--accent-challenge);
  border-radius:6px;
  padding:8px 10px;
  font-size:.95rem;
}
.hint-item small{
  display:block; color:var(--text-dim);
  font-size:.72rem; letter-spacing:.04em; margin-bottom:2px;
}

/* Assistance rows */
.kv{ display:grid; gap:6px; }
.kv-row{
  background:var(--c-surface-1); border:1px dashed var(--c-dash-border); border-radius:6px;
  padding:8px 10px;
}
.kv-row .subtle{ color:var(--text-dim); font-size:.78rem; margin-bottom:2px; }

/* Grammar correction diff styles */
.gc-box{ 
  background:var(--c-gc-bg);
  border:1px solid var(--c-gc-border);
  border-radius:6px;
  padding:6px 8px;
}
.gc-row{
  display:grid; 
  grid-template-columns: 1fr 2fr; 
  gap:8px; 
  align-items:flex-start;
  margin:2px 0;
}
.gc-label{
  color:var(--c-gc-label);
  font-size:.78rem;
  letter-spacing:.02em;
  padding-top:2px;
}
.gc-line{
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.55;
}
.gc-ins{ color:var(--accent-challenge); background:var(--c-gc-add-bg); padding:0 1px; border-radius:2px; }
.gc-del{ color:#ff9d9d; text-decoration:line-through; background:var(--c-gc-del-bg); padding:0 1px; border-radius:2px; }
.gc-legend{
  margin-top:6px; 
  color:var(--text-dim);
  font-size:.76rem;
}
.gc-legend .sw{ display:inline-block; width:10px; height:10px; border-radius:2px; vertical-align:middle; margin:-2px 4px 0 8px; }
.gc-legend .sw.add{ background:var(--c-gc-add-bg); border:1px solid var(--c-gc-add-border); }
.gc-legend .sw.del{ background:var(--c-gc-del-bg); border:1px solid var(--c-gc-del-border); }

/* Make the log fill up to ~half of the viewport, still with a floor and ceiling */
#bottomPanel > .panel-body{
  overflow:hidden !important;
  overflow-y:hidden !important;
  overflow-x:hidden !important;
  display:flex;
  min-height:0;
}
#eventLog{
  flex:1 1 auto;
  min-height:0;
  max-height:none;
  height:100%;
  overflow-y:auto;
  overflow-x:hidden;
}
#eventLog .log-item{
  display:flex; align-items:flex-start; gap:6px;
  padding:6px 8px; margin:2px 0;
  font-size:0.75rem;
  background:var(--c-event-item-bg); border-left:4px solid var(--c-event-item-border); border-radius:4px;
}
#eventLog .log-info{ border-left-color:#3ea8ff; }
#eventLog .log-success{ border-left-color:#22c55e; }
#eventLog .log-warn{ border-left-color:#facc15; }
#eventLog .log-error{ border-left-color:#ef4444; }
#eventLog .ts{ color:var(--text-dim); flex:0 0 auto; min-width:74px; }
#eventLog .txt{ white-space:pre-wrap; }

/* --- Agent chat bubbles --- */
#agentHistory{
  display:flex; flex-direction:column; gap:14px;
  padding-right:4px;
}
#agentHistory .msg{
  max-width: 88%;
  padding:10px 12px;
  border-radius:12px;
  position:relative;
  white-space:pre-wrap;
  word-break:break-word;
}
#agentHistory .msg.agent{
  align-self:flex-start;
  background:var(--c-bubble-agent-bg);
  border:1px solid var(--c-bubble-agent-border);
  color:var(--c-bubble-agent-text);
  box-shadow: 0 1px 0 var(--c-bubble-agent-inset) inset;
}
#agentHistory .msg.user{
  align-self:flex-end;
  background:var(--c-bubble-user-bg);
  border:1px solid var(--c-bubble-user-border);
  color:var(--c-bubble-user-text);
  box-shadow: 0 1px 0 var(--c-bubble-user-inset) inset;
}
#agentHistory .msg.agent::before{
  content: attr(data-label);
  position:absolute; top:-14px; left:6px;
  font-size:.70rem; color:var(--text-dim);
  letter-spacing:.02em;
}
#agentHistory .msg.user::before{
  content: attr(data-label);
  position:absolute; top:-14px; right:6px;
  font-size:.70rem; color:var(--text-dim);
  letter-spacing:.02em;
}

/* Resizers */
.v-resizer, .h-resizer{ background:var(--c-resizer); }
.v-resizer{ cursor:col-resize; }
.h-resizer{ cursor:row-resize; }

/* Grid placement (desktop) */
#agentPanel{ grid-column:1/2; grid-row:1/2; }
#vr{ grid-column:2/3; grid-row:1/2; }               /* left <-> middle */
#rightTop{ grid-column:3/4; grid-row:1/2; }         /* middle (task) */
#vrRight{ grid-column:4/5; grid-row:1/4; }          /* middle <-> far-right (full height) */
#taskHelp{ grid-column:5/6; grid-row:1/4; }         /* far-right: Help + Settings continuous */
#hr{ grid-column:1/5; grid-row:2/3; }               /* top/bottom divider (NOT crossing far-right) */
#bottomPanel{ grid-column:1/5; grid-row:3/4; }      /* bottom: left + middle only */

/* Removed the old internal splitter */
/* #hrRight no longer used */

/* ---------- Compact buttons just in Challenge panel ---------- */
#challengePanel .btn.small{ padding:4px 8px; min-height:30px; font-size:.86rem; }
#challengePanel .btn-group{ gap:6px; }

/* Corner favicon (top-right) */
#cornerFavicon{
  position:fixed;
  top:0px; right:10px;
  width:50px; height:50px;
  z-index:1000;
  opacity:.9;
}
#cornerFavicon img{ width:100%; height:100%; display:block; }

/* =========================
   Responsive tweaks
   =========================*/

/* Buttons under the input once width tightens a bit */
@media (max-width: 1280px){
  #answerBar{
    grid-template-columns: 1fr;         /* stack input then buttons column */
  }
  .btn-group{
    grid-column: 1 / -1;                /* full row under input */
  }
}

/* Mobile optimizations */
@media (max-width: 880px){

  /* Stack app into one column */
  #grid{
    grid-template-columns: 1fr;
    /* task | gap | agent | gap | help+settings | gap | log */
    grid-template-rows: auto var(--gap) auto var(--gap) auto var(--gap) auto;
    height:auto;
    min-height:100svh;
  }

  /* Order */
  #rightTop{ grid-column:1/2; grid-row:1/2; }
  #hr{ grid-column:1/2; grid-row:2/3; height:var(--gap); }
  #agentPanel{ grid-column:1/2; grid-row:3/4; }
  #taskHelp{ grid-column:1/2; grid-row:5/6; }
  #bottomPanel{ grid-column:1/2; grid-row:7/8; }

  /* Hide vertical resizers on mobile */
  #vr, #vrRight{ display:none !important; }

  .panel-header{ padding:8px 10px; gap:8px; }
  .panel > .panel-body{ padding:10px; }

  #agentHistory .msg{ max-width: 96%; }

  /* Buttons: already vertical; keep touch-friendly */
  .btn-group .btn.small{
    width: 100%;
  }

  /* Labels / pills a bit tighter */
  .pill{ padding:5px 8px; font-size:.82rem; }
  .section-label{ font-size:.78rem; }

  /* Event log: single internal scroller */
  #eventLog{ min-height:0; max-height:none; height:100%; }
}

@media (max-width: 440px){
  .panel-header{ padding:5px 8px; }
  .panel > .panel-body{ padding:8px; }
  #answerInput{ min-height:48px; }
  #eventLog{ min-height:0; max-height:none; height:100%; }
  #agentSendBtn{
    min-width:62px;
    right:5px;
    top:5px;
  }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .spin{ animation:none !important; }
  .led.reconnecting{ animation:none !important; }
}

/* =========================
   Nested scroll enablers
   =========================*/
#grid, #agentPanel, #rightTop, #bottomPanel, #taskHelp { min-height: 0; }
#challengePanel .panel-body{
  position: relative;
  overflow-x: hidden;
}

/* --- Event log header compact --- */
#eventLogControls{ margin:0; padding:0; gap:6px; }
#eventLogControls .btn.small{ padding: 3px 6px; min-height: 24px; font-size: .78rem; }

/* ===================================================================
   Answer actions: improved layout, icon, and distinct colors
   =================================================================== */

/* Always put buttons under the input (all widths) */
#answerBar{
  grid-template-columns: 1fr;                 /* single column: input then buttons */
}
#answerBar .btn-group{
  grid-column: 1 / -1;
  display: grid;                              /* override earlier flex */
  gap: 6px;
  grid-template-columns: repeat(auto-fit, minmax(96px, max-content));
  justify-content: end;                       /* right-align on wide screens */
  align-items: stretch;
}
#answerBar .btn-group .btn.small{
  white-space: nowrap;
  text-align: center;
}

/* Distinct colors for Submit (emerald) and Next (azure) */
#answerSendBtn{
  background:var(--c-accent-submit-bg);
  border-color:var(--c-accent-submit-border);
  color:var(--c-accent-submit-text);
}
#answerSendBtn:hover{ background:var(--c-submit-hover); }

#newChallengeBtn{
  background:var(--c-accent-next-bg);
  border-color:var(--c-accent-next-border);
  color:var(--c-accent-next-text);
}
#newChallengeBtn:hover{ background:var(--c-next-hover); }

#speechToTextBtn[data-recording="true"]{
  border-color:#ef4444;
  color:#ffd4d4;
  background:#2a1215;
}
#speechToTextBtn[data-busy="true"]{
  border-color:var(--accent-agent);
  color:#d9ecff;
  background:#142131;
}

/* Mobile: fixed 2-row layout: Submit+Next, then Assist+STT+Hint+Speak. */
@media (max-width: 880px){
  #answerBar .btn-group{
    grid-template-columns: repeat(4, minmax(0, 1fr));
    grid-template-areas:
      "submit submit next next"
      "assist stt hint speak";
    justify-content: stretch;
  }
  #answerBar .btn-group .btn.small{
    width:auto;                 /* override earlier 100% width */
    min-height:36px;
    font-size:.82rem;
    padding:6px 6px;
  }
  #answerSendBtn { grid-area: submit; }
  #newChallengeBtn { grid-area: next; }
  #assistBtn { grid-area: assist; }
  #speechToTextBtn { grid-area: stt; }
  #getHintBtn { grid-area: hint; }
  #speakInputBtn { grid-area: speak; }
}
@media (max-width: 440px){
  #answerBar .btn-group .btn.small{
    font-size:.78rem;
    min-height:34px;
    padding:5px 4px;
  }
}

.reload-modal{
  position:fixed;
  inset:0;
  z-index:2100;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--c-modal-overlay);
  padding:16px;
}
.reload-modal.hidden{ display:none !important; }
.reload-modal-card{
  width:min(440px, 96vw);
  background:var(--c-modal-card);
  border:1px solid var(--c-modal-border);
  border-radius:10px;
  padding:14px;
  box-shadow:0 16px 48px rgba(0,0,0,.45);
}
.reload-title{
  font-size:.95rem;
  font-weight:700;
  color:var(--c-modal-title);
  margin-bottom:6px;
  letter-spacing:.02em;
}
.reload-copy{
  font-size:.86rem;
  color:var(--c-modal-copy);
  line-height:1.45;
}
.reload-actions{
  margin-top:12px;
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
#reloadLeaveBtn{
  background:var(--c-accent-next-bg);
  border-color:var(--c-accent-next-border);
  color:var(--c-accent-next-text);
}
